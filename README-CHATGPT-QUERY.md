# ChatGPT Query Service with Scrapeless Browser

A powerful service to query ChatGPT using Scrapeless Cloud Browser, extracting responses with citations, links, images, and products. This implementation follows the GEO (Generative Engine Optimization) automation approach.

## Features

- **Real Browser Environment**: Uses Scrapeless cloud browser to get authentic ChatGPT responses
- **Multi-region Support**: Query from 195+ countries with automatic proxy routing
- **Comprehensive Data Extraction**:
  - Text/HTML/Raw response formats
  - Citations with URLs, titles, and descriptions
  - Attached links in responses
  - Image cards generated by ChatGPT
  - Recommended products with details
- **Session Isolation**: Each query runs in an independent browser session
- **Anti-Detection**: Built-in fingerprinting and date randomization
- **Session Recording**: Optional recording for debugging

## Installation

First, install the required dependency:

```bash
bun install puppeteer-core
```

The service is already integrated into your application at:
- Service: [src/services/chatgpt-query.ts](src/services/chatgpt-query.ts)
- API Endpoint: [src/index.ts](src/index.ts) - `/api/chatgpt/query`

## Configuration

Make sure your Scrapeless API key is set as an environment variable:

```bash
export SCRAPELESS_API_KEY=your_actual_api_key
```

## API Usage

### Endpoint

```
POST /api/chatgpt/query
```

### Request Body

```json
{
  "prompt": "What makes Trae.ai different from other AI solutions?",
  "proxyCountry": "US",
  "sessionName": "Brand Analysis",
  "webSearch": true,
  "sessionRecording": false,
  "answerType": "text",
  "timeout": 180000
}
```

### Request Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `prompt` | string | Yes | - | The question to ask ChatGPT |
| `proxyCountry` | string | No | "US" | Country code (US, JP, UK, etc.) |
| `sessionName` | string | No | "ChatGPT Query" | Name for the browser session |
| `webSearch` | boolean | No | true | Enable web search in ChatGPT |
| `sessionRecording` | boolean | No | false | Record session for debugging |
| `answerType` | string | No | "text" | Response format: "text", "html", or "raw" |
| `timeout` | number | No | 180000 | Timeout in milliseconds |

### Response Format

```json
{
  "prompt": "What makes Trae.ai different from other AI solutions?",
  "success": true,
  "answer": "Trae.ai differentiates itself through...",
  "url": "https://chatgpt.com/?q=What+makes+Trae.ai+different...",
  "countryCode": "US",
  "duration": 12.45,
  "citations": [
    {
      "url": "https://example.com/article",
      "icon": "https://example.com/favicon.ico",
      "title": "Article Title",
      "description": "Article description"
    }
  ],
  "linksAttached": [
    {
      "position": 1,
      "text": "Learn more",
      "url": "https://example.com"
    }
  ],
  "imageCards": [
    {
      "position": 1,
      "url": "https://example.com/image.png"
    }
  ],
  "products": [
    {
      "url": "https://example.com/product",
      "title": "Product Name",
      "imageUrls": ["https://example.com/product.jpg"]
    }
  ]
}
```

## Example Usage

### Using curl

```bash
curl -X POST http://localhost:3000/api/chatgpt/query \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "What makes Trae.ai different from other AI solutions?",
    "proxyCountry": "US",
    "webSearch": true
  }'
```

### Using JavaScript/TypeScript

```typescript
const response = await fetch('http://localhost:3000/api/chatgpt/query', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    prompt: 'What makes Trae.ai different from other AI solutions?',
    proxyCountry: 'US',
    webSearch: true,
  }),
});

const data = await response.json();
console.log(data);
```

### Batch Queries for GEO Analysis

```typescript
const questions = [
  "What is the best AI automation tool?",
  "Compare AI automation platforms",
  "What makes Trae.ai different from other AI solutions?",
  "Top AI solutions for enterprise",
];

const results = await Promise.all(
  questions.map(async (prompt) => {
    const response = await fetch('http://localhost:3000/api/chatgpt/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, proxyCountry: 'US' }),
    });
    return response.json();
  })
);

// Analyze brand mentions
results.forEach(result => {
  const brandMentioned = result.answer?.includes('YourBrand');
  console.log(`Question: ${result.prompt}`);
  console.log(`Brand mentioned: ${brandMentioned}`);
  console.log(`Citations: ${result.citations?.length || 0}`);
  console.log('---');
});
```

## Multi-Region Testing

Query ChatGPT from different countries to see how responses vary:

```typescript
const countries = ['US', 'UK', 'JP', 'DE', 'FR'];

const results = await Promise.all(
  countries.map(async (country) => {
    const response = await fetch('http://localhost:3000/api/chatgpt/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: 'Best AI automation tools',
        proxyCountry: country,
      }),
    });
    return { country, data: await response.json() };
  })
);

console.log('Regional differences in ChatGPT responses:');
results.forEach(({ country, data }) => {
  console.log(`\n${country}:`);
  console.log(`Citations: ${data.citations?.length || 0}`);
  console.log(`Products: ${data.products?.length || 0}`);
});
```

## GEO Analysis Workflow

### 1. Batch Query ChatGPT

Run your target questions through the API and collect responses:

```bash
curl -X POST http://localhost:3000/api/chatgpt/query \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Your question here"}' \
  > response.json
```

### 2. Export to CSV

Use the JSON responses to create a CSV file with these columns:

- `prompt`: The question asked
- `answer`: ChatGPT's response
- `brandCount`: Number of times your brand appears
- `rivalCount`: Number of times competitors appear
- `gap`: rivalCount - brandCount (negative = opportunity)
- `citationsCount`: Number of citations
- `productsCount`: Number of products mentioned

### 3. Analyze Opportunities

Sort by `gap` descending to find:
- **gap = 0**: No one mentioned - create content immediately
- **gap > 0**: Competitors mentioned - write comparison articles
- **gap < 0**: You're already winning - maintain content

## Running the Server

Start the development server:

```bash
bun run dev
```

The server will start at `http://localhost:3000`

For production:

```bash
bun run start
```

## How It Works

1. **Browser Connection**: Connects to Scrapeless cloud browser with your API key
2. **Navigation**: Opens ChatGPT with your query parameters
3. **Response Monitoring**: Waits for ChatGPT to complete its response
4. **Data Extraction**:
   - Captures text response
   - Extracts citations by clicking footnotes
   - Collects image cards from galleries
   - Gathers product recommendations
   - Compiles attached links
5. **Clean Response**: Returns structured JSON with all extracted data

## Key Advantages

### vs OpenAI API
- ✅ No account preference bias
- ✅ Multi-region authentic responses
- ✅ Lower cost (time-based vs token-based)
- ✅ Extracts citations and visual content
- ✅ Gets exactly what users see

### vs Manual Querying
- ✅ Automated batch processing
- ✅ Consistent data structure
- ✅ 1000+ concurrent queries
- ✅ Multi-region testing
- ✅ Session recording for debugging

## Troubleshooting

### "Redirected to OpenAI login page"
- This usually means the region is unavailable or requires authentication
- Try a different `proxyCountry`
- Ensure your Scrapeless API key is valid

### "Query timeout"
- Increase the `timeout` parameter
- ChatGPT may be slow or unavailable
- Check Scrapeless service status

### "No citations found"
- Not all responses include citations
- Try adding `"webSearch": true` to enable web search
- Some questions don't trigger citation behavior

## License

This implementation is based on the Scrapeless GEO automation guide.

## Resources

- [Scrapeless Documentation](https://docs.scrapeless.com)
- [Scrapeless API Key](https://app.scrapeless.com)
- [GEO Strategy Guide](https://scrapeless.com/blog/geo-automation)
